<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  <meta name=referrer content=never>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>视频直播 | 思想直播信号</title>
  <meta name="description" content="整个直播流程分为几个关键步骤：  主播客户端，将本地采集的视频推送到CDN CDN对视频流进行缓存以及转发 观众客户端，拉取CDN中缓存的视频流进行播放CDN技术原理CDN全称为Content Delivery Network，即内容分发网络，是一个策略性部署的整体系统，主要用来解决由于网络带宽小、用户访问量大、网点分布不均与等导致用户访问网站速度慢的问题。从上可看出，通过增加新的一层网络架构，将">
<meta name="keywords" content="视频">
<meta property="og:type" content="article">
<meta property="og:title" content="视频直播">
<meta property="og:url" content="https://wonderxiao.github.io/2017/10/28/视频直播/index.html">
<meta property="og:site_name" content="思想直播信号">
<meta property="og:description" content="整个直播流程分为几个关键步骤：  主播客户端，将本地采集的视频推送到CDN CDN对视频流进行缓存以及转发 观众客户端，拉取CDN中缓存的视频流进行播放CDN技术原理CDN全称为Content Delivery Network，即内容分发网络，是一个策略性部署的整体系统，主要用来解决由于网络带宽小、用户访问量大、网点分布不均与等导致用户访问网站速度慢的问题。从上可看出，通过增加新的一层网络架构，将">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-27_直播1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-27_CDN%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E5%9B%BE.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-27_liveStructure.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2014-10-27_CDN%E7%9B%B4%E6%92%AD%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_%E7%BD%91%E7%BB%9C%E6%97%B6%E5%BB%B6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_134746.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-05_%E7%BD%91%E7%BB%9C%E4%B8%A2%E5%8C%85.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_132424.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_132701.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_133127.png">
<meta property="og:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_133412.png">
<meta property="og:updated_time" content="2018-05-04T13:53:29.789Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="视频直播">
<meta name="twitter:description" content="整个直播流程分为几个关键步骤：  主播客户端，将本地采集的视频推送到CDN CDN对视频流进行缓存以及转发 观众客户端，拉取CDN中缓存的视频流进行播放CDN技术原理CDN全称为Content Delivery Network，即内容分发网络，是一个策略性部署的整体系统，主要用来解决由于网络带宽小、用户访问量大、网点分布不均与等导致用户访问网站速度慢的问题。从上可看出，通过增加新的一层网络架构，将">
<meta name="twitter:image" content="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-27_直播1.png">
  <!-- Canonical links -->
  <link rel="canonical" href="https://wonderxiao.github.io/2017/10/28/视频直播/index.html">
  
    <link rel="alternate" href="/atom.xml" title="思想直播信号" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  <!-- font-awesome CSS -->
  <!-- <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="/css/style.css">
  
    
    

</head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://wonderxiao.github.io" target="_blank">
          <img class="img-circle img-rotate" src="/images/tu.jpg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">wonderxiao</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md">Network Enginner &amp; Designer</h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Chengdu, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav">
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
				
			
			<span class="menu-title">首页</span>
			
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
				
			
			<span class="menu-title">归档</span>
			
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
				
			
			<span class="menu-title">分类</span>
			
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
				
			
			<span class="menu-title">标签</span>
			
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
				
			
			<span class="menu-title">项目</span>
			
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-books">
          <a href="/books">
            
            <i class="icon icon-book-fill"></i>
            
				
			
			<span class="menu-title">书单</span>
			
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-album">
          <a href="/album">
            
            <i class="icon icon-eye-fill"></i>
            
			
			<span class="menu-title">相册</span>
				
			
          </a>
        </li>
        
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
				
			
			<span class="menu-title">关于</span>
			
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wonderxiao" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://weibo.com/u/1803630397" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内存管理/">内存管理</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/单位/">单位</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/博客/">博客</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作/">工作</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/科研/">科研</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/视频/">视频</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/路由器/">路由器</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">标签</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/">C++</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenWrt/">OpenWrt</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gdb调试/">gdb调试</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux命令/">linux命令</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socket编程/">socket编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存分配/">内存分配</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/单位转换/">单位转换</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据存储/">大数据存储</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/正则表达式/">正则表达式</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/汇编/">汇编</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/流量识别/">流量识别</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/类型转换/">类型转换</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/视频/">视频</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面试/">面试</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">归档</h3>
    <div class="widget-body">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled no-thumbnail">
        
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/linux/">linux</a>
              </p>
              <p class="item-title">
                <a href="/2018/05/10/wget命令/" class="title">wget命令</a>
              </p>
              <p class="item-date">
                <time datetime="2018-05-09T18:57:19.000Z" itemprop="datePublished">2018-05-09</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                
              </p>
              <p class="item-title">
                <a href="/2018/05/07/tinyhttpd源码分析（一）/" class="title">tinyhttpd源码分析（一）</a>
              </p>
              <p class="item-date">
                <time datetime="2018-05-06T16:34:32.000Z" itemprop="datePublished">2018-05-06</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/linux/">linux</a>
              </p>
              <p class="item-title">
                <a href="/2018/05/05/GDB调试工具/" class="title">GDB调试工具</a>
              </p>
              <p class="item-date">
                <time datetime="2018-05-05T10:02:59.000Z" itemprop="datePublished">2018-05-05</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/算法/">算法</a>
              </p>
              <p class="item-title">
                <a href="/2018/03/29/位图学习/" class="title">位图学习</a>
              </p>
              <p class="item-date">
                <time datetime="2018-03-29T09:08:46.000Z" itemprop="datePublished">2018-03-29</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/科研/">科研</a>
              </p>
              <p class="item-title">
                <a href="/2018/03/28/网络流量识别/" class="title">网络流量识别</a>
              </p>
              <p class="item-date">
                <time datetime="2018-03-28T10:08:52.000Z" itemprop="datePublished">2018-03-28</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<main class="main" role="main">
  <div class="content">
  <article id="post-视频直播" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      视频直播
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/2017/10/28/视频直播/" class="article-date">
	  <time datetime="2017-10-27T20:41:24.000Z" itemprop="datePublished">2017-10-27</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/科研/">科研</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/视频/">视频</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2017/10/28/视频直播/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 3,487(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 12(分)</span>
	

      </div>
    </div>
    <div class="article-entry markdown-body" itemprop="articleBody">
      
        <p>整个直播流程分为几个关键步骤：</p>
<ul>
<li>主播客户端，将本地采集的视频推送到CDN</li>
<li>CDN对视频流进行缓存以及转发</li>
<li>观众客户端，拉取CDN中缓存的视频流进行播放<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-27_直播1.png" alt="直播架构"><h2 id="CDN技术原理"><a href="#CDN技术原理" class="headerlink" title="CDN技术原理"></a>CDN技术原理</h2>CDN全称为Content Delivery Network，即内容分发网络，是一个策略性部署的整体系统，主要用来解决由于网络带宽小、用户访问量大、网点分布不均与等导致用户访问网站速度慢的问题。<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-27_CDN%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="CDN架构"><br>从上可看出，通过增加新的一层网络架构，将网站的内容发布到离用户最近的网络节点上。这样，用户就可以就近获取所需内容，解决之前网络拥塞、访问延迟高的问题，提高用户体验。<br>对于直播业务来说，则将Web服务器换成主播客户端，如下图所示。<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-27_liveStructure.png" alt=""><br>由于视频占用带宽大，与普通Web服务差别较大，这样CDN优势更明显：<br>网络拥塞减少，访问延迟降低，带宽得到更好的控制。<h2 id="CDN直播中常用的流媒体协议"><a href="#CDN直播中常用的流媒体协议" class="headerlink" title="CDN直播中常用的流媒体协议"></a>CDN直播中常用的流媒体协议</h2></li>
<li>RTMP<br>Real Time Messaging Protocol，是基于TCP，由Adobe公司为Flash播放器和服务器之间音频、视频传输开发的开放协议</li>
<li>HLS<br>HTTP Live Streaming，是基于HTTP的，是Apple公司开放的音视频传输协议</li>
<li>HTTP FLV<br>将RTMP封装在HTTP协议之上的，可以更好的穿透防火墙等<blockquote>
<p>CDN主要包含源站、缓存服务器、智能DNS、客户端等几个主要组成部分。</p>
</blockquote>
</li>
<li>源站<br>发布内容的原始站点。添加、删除和更改网站的文件，都是在源站上进行的；另外缓存服务器所抓取的对象也全部来自于源站。对于直播来说，源站为主播客户端。</li>
<li>缓存服务器<br>直接提供给用户访问的站点资源，由一台或数台服务器组成；当用户发起访问时，他的访问请求被智能DNS定位到离他较近的缓存服务器。如果用户所请求的内容刚好在缓存里面，则直接把内容返还给用户；如果访问所需的内容没有被缓存，则缓存服务器向邻近的缓存服务器或直接向源站抓取内容，然后再返还给用户。</li>
<li>智能DNS<br>整个CDN技术的核心，它主要根据用户的来源，以及当前缓存服务器的负载情况等，将其访问请求指向离用户比较近且负载较小的缓存服务器。通过智能DNS解析，让用户访问同服务商下、负载较小的服务器，可以消除网络访问慢的问题，达到加速作用。</li>
<li>客户端<br>发起访问的普通用户。对于直播来说，就是观众客户端。<br>对于直播业务，CDN整体架构如下图所示：<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2014-10-27_CDN%E7%9B%B4%E6%92%AD%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84.png" alt="CDN整体架构"></li>
<li>主要流程：</li>
</ul>
<ol>
<li>主播开始进行直播，向智能DNS发送解析请求；</li>
<li>智能DNS返回最优CDN节点IP地址；</li>
<li>主播端采集音视频数据，发送给CDN节点，CDN节点进行缓存等处理；</li>
<li>观众端要观看此主播的视频，向智能DNS发送解析请求；</li>
<li>智能DNS返回最优CDN节点IP地址；</li>
<li>观众端向CDN节点请求音视频数据；</li>
<li>CDN节点同步其他节点的音视频数据；</li>
<li>CDN节点将音视频数据发送给观众端；</li>
</ol>
<p>一提到直播，就会涉及到播放延时的问题，那么为什么会播放延时呢？</p>
<h3 id="1-网络延时"><a href="#1-网络延时" class="headerlink" title="1.网络延时"></a>1.网络延时</h3><p>网络延时是指从主播端采集，到观众端播放之间的时间差。这里不考虑主播端采集对视频进行编码的时间及观众端观看视频对解码的时间，仅考虑网络传输中的延时。<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_%E7%BD%91%E7%BB%9C%E6%97%B6%E5%BB%B6.png" alt="网络时延"><br>假设该链路上有缓存，时间应该添加缓存时间。另外，数据传输过程中还涉及到逻辑上的交互，例如包的重传以及确认，以及缓存上的一些逻辑等，会在这个基础上又增加很多。</p>
<p>在节点较少、网络情况较好的情况下，那么网络延时对应也是最小，加上一定的缓存，可以控制延时在1s~2s左右。但是节点多、网络差的情况下，网络延时会对应增大，经验来说延时可以达到15s以上。</p>
<h3 id="2-网络抖动"><a href="#2-网络抖动" class="headerlink" title="2.网络抖动"></a>2.网络抖动</h3><p>网络抖动，是指数据包的到达顺序、间隔和发出时不一致。比如说，发送100个数据包，每个包间隔1s发出。结果第27个包在传输过程中遇到网络拥塞，造成包27不是紧跟着26到达的，而是延迟到87后面才达。在直播中，这种抖动的效果实际上跟丢包是一样的。因为你不能依照接收顺序把内容播放出来，否则会造成失真。<br>134746<br><strong>网络抖动</strong>，会造成播放延时对应增大。如果网络中抖动较大，会造成播放卡顿等现象。具体情况如下图：<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_134746.png" alt=""><br>如上图，主播在t3和t5发出的包，分别在t3’和t5’到达，但中间延时较大，即发生了网络抖动，这样造成观众端观看视频的延时会不断增大。</p>
<h3 id="3-网络丢包"><a href="#3-网络丢包" class="headerlink" title="3.网络丢包"></a>3.网络丢包</h3><p>CDN直播中用到的RTMP、HLS、HTTP FLV等协议都是在TCP的基础之上。TCP一个很重要的特性是可靠性，即不会发生数据丢失的问题。为了保证可靠性，TCP在传输过程中有3次握手，见下图。首先客户端会向服务端发送连接请求，服务端同意后，客户端会确认这次连接。这就是3次握手。接着，客户端就开始发送数据，每次发送一批数据，得到服务端的“收到”确认后，继续发送下一批。TCP为了保证传到，会有自动重传机制。如果传输中发生了丢包，没有收到对端发出的“收到”信号，那么就会自动重传丢失的包，一直到超时。<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-10-05_%E7%BD%91%E7%BB%9C%E4%B8%A2%E5%8C%85.png" alt="网络丢包"><br>由于互联网的网络状况是变化的，以及主播端的网络状况是无法控制的。所以当网络中丢包率开始升高时，重传会导致延时会不断增大，甚至导致不断尝试重连等情况，这样不能有效的缓存，严重情况下会导致观众端视频无法观看。</p>
<p>从底层协议和布网结构上，使用基于UDP协议的传输方案。SD-RTN（Software-Defined Real Time Net work），软件定义实时传输网络，是一种新型的专为内容实时传输而设计，基于UDP协议的网络架构。SD-RTN通过在互联网上不同地区的数据中心放置软件组网单元，相互连接互相调度，在现有的公共互联网基础上构建一层新的虚拟网络。能够实时根据各节点的连接、传输状况、负载状况、到用户的距离和响应时间，自动分配最优最通畅的传输路径，达到实时传输需要的质量保障级别。</p>
<p>CDN与SD-RTN对比情况：</p>
<ul>
<li>基本原理不同<br>CDN是存储转发结构，设计目的是在各个边缘节点缓存待分发内容，结构上从源站到观众是伞状多级缓存放大方式。SD-RTN本质上一个实时传输网络，用户的数据在网络单元内部和传输线路上都以实时交换方式传送，UDP实现的传输协议，不会因为前一个包的丢失或延迟导致下后续包的延迟送达，而丢包可以用对延迟更友好的方式修复或补偿出来，从而能够保证最低延迟。</li>
<li>底层协议不同<br>SD-RTN采用了专为实时传输设计的UDP协议，避免了采用TCP的延时不可控缺点。能够大大缩短交互延时，延时可从CDN方案的数秒，降低到数百毫秒。</li>
<li>内容分发机制不同<br>SD-RTN是基于自定义路由，选择最优传输路径，直接将内容端到端传输，数据在网络单元中从不缓存，从而最大可能的降低延迟，同时内容安全性也更好。CDN是将内容缓存于缓存服务器中，再将内容就近下发，所以CDN更适合做内容分发，一对多的场景。</li>
<li>使用场景不同<br>SD-RTN适用于要求极低时延的实时互动场景，例如网络电话、视频会议、有主播与观众交互需求的互动直播等。CDN适用于对时延要求不高的场景，例如对延时要求不高、类似电视的单点直播、网站加速等。<h3 id="SD-RTN的优势"><a href="#SD-RTN的优势" class="headerlink" title="SD-RTN的优势"></a>SD-RTN的优势</h3></li>
<li>时延大大缩短<br>直播延时可从基于TCP的方案的数秒，降低到数百毫秒。这一延迟范围，属于实时通信或准实时通信延迟的范畴。在这一级别上，主播和观众可以基本重现在现场活动中的交互体验，从而大大释放了内容制作者的潜力，也为业务运营者创造新业务形式打开了无限的空间和可能。</li>
<li>抗丢包能力强<br>SD-RTN中可以针对用户网络使用更多的策略模型和技术，这样在30%丢包时，依然能够进行正常直播。而基于TCP的直播方案在丢包2%时就明显卡顿，达到30%经常已断开连接，无法进行直播。</li>
</ul>
<p>直播中若要与用户交互，常见有两种方式：</p>
<ul>
<li>文字</li>
<li>连麦，主播可面对面与观众进行交互，增加互动性<h3 id="连麦分析"><a href="#连麦分析" class="headerlink" title="连麦分析"></a>连麦分析</h3></li>
</ul>
<ol>
<li>多路RTMP流实现<br>RTMP是目前主播最常用的协议，实现连麦方式若下图：<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_132424.png" alt=""><br>当有连麦者时，则主播端和连麦者端，都分别推一路RTMP流到CDN，CDN再将这两路RTMP流发送给观众端，观众端将两路RTMP流合成为一个画面。这种方式的优点是实现简单，但缺点比较多：</li>
</ol>
<ul>
<li>主播与连麦者如果要进行交互，则考虑到上面分析的延时问题，在这里延时需要至少加大一倍，这样对于实时交互来说，完全无法接受；</li>
<li>主播与连麦者交互时，声音会产生干扰，形成回音；</li>
<li>观众端要接收两条视频流，带宽、流量消耗过大，并且两路视频流解码播放，耗费CPU等资源也非常多；</li>
</ul>
<ol>
<li>主播端与连麦者P2P<br>主播端与连麦者之间使用P2P方式进行交互，然后主播端将自己和连麦者的视频进行合并，再推到CDN上，CDN再发送给观众端，如下图：<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_132701.png" alt=""></li>
</ol>
<ul>
<li>优点<br>主播和连麦者之间使用P2P，网络质量较好，延迟较小，保证了两者之间交互不会有非常大的延时<br>可以解决声音的干扰问题，消除回声</li>
<li>缺点<br>P2P在某些网络下无法穿透，有些观众根本无法与主播端进行交互;<br>主播端需要上传两路视频：一路P2P与连麦者进行交互，一路使用RTMP推到CDN。还要下载一路视频：连麦者P2P发送过来的交互数据。所以主播端要求带宽需要较高，网络较差时无法进行主播;<br>主播端要进行多路视频的编码、解码，要求主播端设备配置比较高，较差的设备也无法进行主播;<br>只能支持一个连麦者，不能支持多个连麦者;<br>由于主播端和连麦者经过CDN合并成一路，因此，不能实现主播端和连麦者视频大小窗口切换。</li>
</ul>
<ol>
<li>服务器端合图<br>主播和连麦者都将视频推送到CDN中，然后CDN内部对这几路视频进行合图，再将其发送给观众端。如下图：<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_133127.png" alt=""></li>
</ol>
<ul>
<li>优点<br>主播和连麦者各路视频都使用RTMP推送到CDN，可以保证延时较小；<br>由于CDN进行视频合图和发送，所以主播不需要很高的带宽；<br>由于CDN进行视频合图，所以主播的设备不需要配置非常高；<br>没有声音干扰问题；<br>可以支持多个连麦者连麦；</li>
<li>缺点<br>CDN需要进行视频的合图，需要额外开发工作，并且逻辑比较复杂；<br>CDN需要进行视频的合图，需要消耗较高服务器资源；<br>CDN合图后的布局难控制；<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3>使用SD-RTN，可以很好的解决多路RTMP、P2P连麦、服务器端合图这几种方案的弱势，并且开发难度降低，合图布局等都可以很好的在客户端上进行控制。<br>具体SD-RTN的架构可以参考下图：<br><img src="https://raw.githubusercontent.com/wonderxiao/BlogPicture/master/photos/2017-11-05_133412.png" alt=""><br>客户端均通过UDP连接SD-RTN架构服务，通过SD-RTN的就近接入策略，让使用者就近接入质量最好的数据节点，经过传输延迟和质量优化的最优路径，自动避免网络拥塞和骨干网络故障的影响，将数据发送给其他客户端。若有常规的长延迟旁路直播，则可以将主播与连麦者合成一路直播流，通过RTMP推到CDN，进行下发。连接这一路的观众，不能参与连麦互动，达到了最佳直播效果。</li>
</ul>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://wonderxiao.github.io/2017/10/28/视频直播/" title="视频直播" target="_blank" rel="external">https://wonderxiao.github.io/2017/10/28/视频直播/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>


<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://wonderxiao.github.io" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/tu.jpg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h3 class="media-heading"><a href="https://wonderxiao.github.io" target="_blank"><span class="text-dark">wonderxiao</span><small class="ml-1x">Network Enginner &amp; Designer</small></a></h3>
        <div>网络工程师</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    
  <section id="comments">
  	
       
<div id="lv-container" data-id="city" data-uid="MTAyMC8zMTM2NS83OTI4">
  <noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
</div>
      
    
  </section>


  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/2017/11/01/内存四区/" title="内存四区"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/2017/10/18/汇编/" title="汇编"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
  </ul>
  
  
  
  <div class="bar-right">
    
    <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter" data-mobile-sites="weibo,qq,qzone"></div>
    
  </div>
  </div>
</nav>
  


</main>

  <footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/wonderxiao" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="https://weibo.com/u/1803630397" target="_blank" title="Weibo" data-toggle=tooltip data-placement=top><i class="icon icon-weibo"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        <div class="publishby">
        	Theme by <a href="https://github.com/cofess" target="_blank"> cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.
        </div>
    </div>
</footer>
  <script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script src="/js/plugin.min.js"></script>
<script src="/js/application.js"></script>
  
    
    
    
        <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {

        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>
    
    
    
        


    
    
        
    
<script defer type="text/javascript">
  (function(d, s) {
    var j, e = d.getElementsByTagName(s)[0];

    if (typeof LivereTower === 'function') { return; }

    j = d.createElement(s);
    j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
    j.async = true;

    e.parentNode.insertBefore(j, e);
  })(document, 'script');
</script>


    
    

    <script defer>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?ebad87ecd6d46b8d0b76f8cdb30318d1";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>




</body>
</html>